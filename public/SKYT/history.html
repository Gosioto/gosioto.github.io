<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKYT | –ò—Å—Ç–æ—Ä–∏—è –ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</title>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π -->
    <link rel="stylesheet" href="css/styles.css">
    <!-- –û—Ç–¥–µ–ª—å–Ω—ã–π history.css ! -->
    <!-- <link rel="stylesheet" href="css/history.css"> -->

    <!-- –ò–∫–æ–Ω–∫–∞ —Å–∞–π—Ç–∞ (favicon) -->
    <!-- <link rel="icon" href="assets/icons/favicon.ico" type="image/x-icon"> -->

    <style>
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ (–ü–µ—Ä–µ–Ω–æ—Å –≤ css) */
        .filter-bar {
            background-color: white;
            padding: var(--space-md);
            margin-bottom: var(--space-lg);
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-md);
            align-items: flex-end;
        }
        .filter-bar .form__group {
            margin-bottom: 0;
            flex-grow: 1;
        }
        .filter-bar .form__group--compact {
             flex-grow: 0;
         }
        .filter-bar button {
            height: calc(var(--text-base) * 1.6 + 2 * var(--space-xs) + 2px);
            white-space: nowrap;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--space-lg);
            background-color: white;
            box-shadow: var(--shadow-sm);
            border-radius: 8px;
            overflow: hidden;
        }
        .history-table th,
        .history-table td {
            padding: var(--space-sm);
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .history-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            font-size: var(--text-sm);
            color: var(--color-dark);
        }
        .history-table tbody tr:hover {
            background-color: #f1f3f5;
        }
        .history-table td a {
            color: var(--color-primary);
        }
         .history-table td .category-badge {
             display: inline-block;
             padding: 2px var(--space-xs);
             font-size: var(--text-xs);
             border-radius: 4px;
             color: white;
             background-color: var(--color-gray);
         }
          .history-table td .category-badge.cat-science { background-color: var(--color-success); }
          .history-table td .category-badge.cat-tech { background-color: var(--color-primary); }
          .history-table td .category-badge.cat-memes { background-color: var(--color-warning); }
          .history-table td .category-badge.cat-social { background-color: #ff6b6b; } 
          .history-table td .category-badge.cat-news { background-color: #495057; }


        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--space-xs);
        }
        .pagination button, .pagination span {
            padding: var(--space-xs) var(--space-sm);
            border: 1px solid var(--color-gray);
            background: white;
            border-radius: 4px;
            cursor: pointer;
        }
         .pagination button:disabled {
             cursor: not-allowed;
             opacity: 0.5;
         }
         .pagination span.current-page {
             background-color: var(--color-primary);
             color: white;
             border-color: var(--color-primary);
             font-weight: 600;
         }
    </style>
</head>
<body>

    <!-- –®–∞–ø–∫–∞ —Å–∞–π—Ç–∞ -->
    <header class="navbar">
        <div class="container navbar__container">
            <a href="index.html" class="navbar__logo">SKYT</a>
            <nav>
                <ul class="navbar__menu">
                    <li><a href="index.html" class="navbar__link">–ì–ª–∞–≤–Ω–∞—è</a></li>
                    <li><a href="features.html" class="navbar__link">–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</a></li>
                    <li><a href="dashboard.html" class="navbar__link">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a></li>
                    <li><a href="history.html" class="navbar__link navbar__link--active">–ò—Å—Ç–æ—Ä–∏—è</a></li>
                    <li><a href="settings.html" class="btn btn--outline">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a></li>
                    <!-- <li><a href="#login" class="btn btn--primary">–í–æ–π—Ç–∏</a></li> -->
                </ul>
            </nav>
        </div>
    </header>

    <main class="section">
        <div class="container">
            <h1>–ò—Å—Ç–æ—Ä–∏—è –ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</h1>

            <!-- –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
            <section class="filter-bar">
                <div class="form__group">
                    <label for="search-query" class="form__label">–ü–æ–∏—Å–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É/URL</label>
                    <input type="text" id="search-query" class="form__control" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å...">
                </div>
                <div class="form__group form__group--compact">
                    <label for="category-filter" class="form__label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select id="category-filter" class="form__control">
                        <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                        <option value="science">–ù–∞—É–∫–∞</option>
                        <option value="tech">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</option>
                        <option value="memes">–ú–µ–º—ã</option>
                        <option value="social">–°–æ—Ü—Å–µ—Ç–∏</option>
                        <option value="news">–ù–æ–≤–æ—Å—Ç–∏</option>
                        <option value="productive">–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–µ</option>
                        <option value="distracting">–†–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–µ</option>
                        <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
                    </select>
                </div>
                 <div class="form__group form__group--compact">
                    <label for="date-from" class="form__label">–î–∞—Ç–∞ –æ—Ç</label>
                    <input type="date" id="date-from" class="form__control">
                </div>
                <div class="form__group form__group--compact">
                    <label for="date-to" class="form__label">–î–∞—Ç–∞ –¥–æ</label>
                    <input type="date" id="date-to" class="form__control">
                </div>
                <button id="apply-filters-btn" class="btn btn--primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </section>

            <!-- –¢–∞–±–ª–∏—Ü–∞ —Å –∏—Å—Ç–æ—Ä–∏–µ–π -->
            <section class="history-display">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
                            <th>–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</th>
                            <th>URL</th>
                            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body">
                        <!-- –°—Ç—Ä–æ–∫–∏ –¥–±–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                        <!--
                        <tr>
                            <td>2023-10-26 14:35:10</td>
                            <td>–ò–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è —Å—Ç–∞—Ç—å—è –æ –∫–≤–∞–Ω—Ç–æ–≤–æ–π —Ñ–∏–∑–∏–∫–µ</td>
                            <td><a href="https://example.com/physics" target="_blank">example.com/physics</a></td>
                            <td><span class="category-badge cat-science">–ù–∞—É–∫–∞</span></td>
                        </tr>
                        <tr>
                            <td>2023-10-26 15:10:22</td>
                            <td>–°–º–µ—à–Ω—ã–µ –∫–æ—Ç–∏–∫–∏ (–≤–∏–¥–µ–æ)</td>
                            <td><a href="https://youtube.com/watch?v=abc" target="_blank">youtube.com/watch?v=abc</a></td>
                             <td><span class="category-badge cat-memes">–ú–µ–º—ã</span></td>
                        </tr>
                         -->
                         <tr>
                            <td colspan="4" style="text-align: center; padding: var(--space-lg);">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td>
                         </tr>
                    </tbody>
                </table>
            </section>

            <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
            <section class="pagination" id="pagination-controls">
                <button id="prev-page" disabled>&laquo; –ù–∞–∑–∞–¥</button>
                <span id="page-info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ <span class="current-page">1</span> –∏–∑ <span id="total-pages">1</span></span>
                <button id="next-page" disabled>–í–ø–µ—Ä–µ–¥ &raquo;</button>
            </section>

        </div>
    </main>

    <!-- –ü–æ–¥–≤–∞–ª -->
    <footer class="footer section" style="background-color: var(--color-dark); color: var(--color-light); margin-top: var(--space-lg);">
        <div class="container text-center">
             <p>&copy; 2000 SKYT Project. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
            <div class="footer-links" style="margin-top: var(--space-sm);">
                <a href="#privacy" style="color: var(--color-gray); margin: 0 var(--space-xs);">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a> |
                <a href="#terms" style="color: var(--color-gray); margin: 0 var(--space-xs);">–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</a> |
                <a href="mailto:support@skyt.example.com" style="color: var(--color-gray); margin: 0 var(--space-xs);">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</a>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = 'http://localhost:3000/api';
            const historyTableBody = document.getElementById('history-table-body');
            const searchInput = document.getElementById('search-query');
            const categoryFilter = document.getElementById('category-filter');
            const dateFromInput = document.getElementById('date-from');
            const dateToInput = document.getElementById('date-to');
            const applyFiltersBtn = document.getElementById('apply-filters-btn');
            const prevPageBtn = document.getElementById('prev-page');
            const nextPageBtn = document.getElementById('next-page');
            const currentPageSpan = document.getElementById('current-page');
            const totalPagesSpan = document.getElementById('total-pages');

            let currentPage = 1;
            let totalPages = 1;
            const limit = 20;

            async function fetchHistory() {
                historyTableBody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: var(--space-lg);">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>`;
                prevPageBtn.disabled = true;
                nextPageBtn.disabled = true;

                const params = new URLSearchParams({
                    page: currentPage,
                    limit: limit,
                });

                const query = searchInput.value.trim();
                const category = categoryFilter.value;
                const dateFrom = dateFromInput.value;
                const dateTo = dateToInput.value;

                if (query) params.append('query', query);
                if (category) params.append('category', category);
                if (dateFrom) params.append('dateFrom', dateFrom);
                if (dateTo) params.append('dateTo', `${dateTo}T23:59:59`);

                try {
                    const response = await fetch(`${API_BASE_URL}/history?${params.toString()}`);

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || `–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
                    }

                    const data = await response.json();
                    renderHistoryTable(data.data || []);
                    totalPages = data.totalPages || 1;
                    updatePagination();

                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏:', error);
                    historyTableBody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: var(--color-danger); padding: var(--space-lg);">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é: ${error.message}</td></tr>`;
                    currentPage = 1;
                    totalPages = 1;
                    updatePagination();
                }
            }

            function renderHistoryTable(items) {
                historyTableBody.innerHTML = '';
                if (!items || items.length === 0) {
                    historyTableBody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: var(--space-lg);">ü§∑‚Äç‚ôÇÔ∏è –ó–∞–ø–∏—Å–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</td></tr>`;
                    return;
                }

                items.forEach(item => {
                    const row = document.createElement('tr');
                    const formattedDate = item.visitedAt
                        ? new Date(item.visitedAt).toLocaleString('ru-RU', {
                            year: 'numeric', month: '2-digit', day: '2-digit',
                            hour: '2-digit', minute: '2-digit'
                        })
                        : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';

                    const shortTitle = item.title && item.title.length > 80 ? item.title.substring(0, 77) + '...' : (item.title || '(–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞)');
                    let displayUrl = item.url || 'N/A';
                    try {
                        const urlObj = new URL(item.url);
                        displayUrl = urlObj.hostname + (urlObj.pathname.length > 1 ? urlObj.pathname.substring(0, 20) + '...' : '');
                    } catch (e) {}

                    const category = item.category || 'unknown';
                    const categoryClass = `cat-${category.toLowerCase().replace(/[^a-z0-9]/g, '-')}`;
                    const categoryBadge = `<span class="category-badge ${categoryClass}">${category}</span>`;

                    row.innerHTML = `
                        <td>${formattedDate}</td>
                        <td>${shortTitle}</td>
                        <td><a href="${item.url}" target="_blank" title="${item.url}">${displayUrl}</a></td>
                        <td>${categoryBadge}</td>
                    `;
                    historyTableBody.appendChild(row);
                });
            }

            function updatePagination() {
                currentPageSpan.textContent = currentPage;
                totalPagesSpan.textContent = totalPages;
                prevPageBtn.disabled = currentPage <= 1;
                nextPageBtn.disabled = currentPage >= totalPages;
            }

            applyFiltersBtn.addEventListener('click', () => {
                currentPage = 1;
                fetchHistory();
            });

            searchInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    currentPage = 1;
                    fetchHistory();
                }
            });

            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    fetchHistory();
                }
            });

            nextPageBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    fetchHistory();
                }
            });

            fetchHistory();
        });
    </script>  

</body>
</html>